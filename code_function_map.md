# Layout Parser Script - Function Map & Code Blocks

## ğŸ“ **Function Location Map** (Line Numbers)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SCRIPT STRUCTURE (1845 lines)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚ IMPORTS & SETUP (1-40)                                                     â”‚
â”‚ â”œâ”€ Standard libraries (logging, sys, typing, etc.)                         â”‚
â”‚ â”œâ”€ Third-party libraries (layoutparser, cv2, PIL, etc.)                    â”‚
â”‚ â””â”€ Configuration (logging, cache setup)                                    â”‚
â”‚                                                                             â”‚
â”‚ EXCEPTION CLASSES (43-56)                                                  â”‚
â”‚ â”œâ”€ LayoutParserError (base)                                                â”‚
â”‚ â”œâ”€ OCRError                                                                â”‚
â”‚ â”œâ”€ TranslationError                                                        â”‚
â”‚ â””â”€ ImageProcessingError                                                    â”‚
â”‚                                                                             â”‚
â”‚ CORE FUNCTIONS (59-1620)                                                   â”‚
â”‚ â”œâ”€ cache_result() (59-85)                                                  â”‚
â”‚ â”œâ”€ translate_text() (86-138)                                               â”‚
â”‚ â”œâ”€ convert_pdf_to_image() (139-144)                                        â”‚
â”‚ â”œâ”€ get_text_style() (145-222)                                              â”‚
â”‚ â”œâ”€ process_sections() (223-325)                                            â”‚
â”‚ â”œâ”€ clean_text() (326-388)                                                  â”‚
â”‚ â”œâ”€ optimize_image_for_ocr() (389-433)                                      â”‚
â”‚ â”œâ”€ process_pdf_pages() (434-517)                                           â”‚
â”‚ â”œâ”€ extract_text_from_block() (518-656)                                     â”‚
â”‚ â”œâ”€ merge_overlapping_blocks() (657-753)                                    â”‚
â”‚ â”œâ”€ get_font_set() (754-826)                                                â”‚
â”‚ â”œâ”€ create_translated_image() (827-1264)                                    â”‚
â”‚ â”œâ”€ safe_* functions (1265-1296)                                            â”‚
â”‚ â”œâ”€ process_blocks_parallel() (1297-1480)                                   â”‚
â”‚ â”œâ”€ create_split_blocks() (1481-1602)                                       â”‚
â”‚ â”œâ”€ should_split_block() (1603-1623)                                        â”‚
â”‚ â””â”€ split_multi_section_blocks() (1624-1645)                                â”‚
â”‚                                                                             â”‚
â”‚ TESTING FRAMEWORK (1646-1720)                                              â”‚
â”‚ â””â”€ TestLayoutParser class with 5 test methods                              â”‚
â”‚                                                                             â”‚
â”‚ VALIDATION FUNCTIONS (1721-1759)                                           â”‚
â”‚ â”œâ”€ validate_pdf()                                                          â”‚
â”‚ â”œâ”€ validate_output_path()                                                  â”‚
â”‚ â””â”€ validate_image()                                                        â”‚
â”‚                                                                             â”‚
â”‚ MAIN EXECUTION (1760-1845)                                                 â”‚
â”‚ â””â”€ main() function with error handling                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— **Function Call Hierarchy**

```
main() [1760]
â”‚
â”œâ”€ lp.Detectron2LayoutModel() [Load AI model]
â”‚
â”œâ”€ validate_pdf() [1721]
â”‚
â”œâ”€ validate_output_path() [1734] (for each output file)
â”‚
â””â”€ process_pdf_pages() [434]
   â”‚
   â”œâ”€ convert_from_path() [pdf2image library]
   â”‚
   â”œâ”€ get_text_style() [145]
   â”‚  â””â”€ fitz.open() [PyMuPDF]
   â”‚
   â”œâ”€ model.detect() [Detectron2 AI model]
   â”‚
   â”œâ”€ merge_overlapping_blocks() [657]
   â”‚
   â”œâ”€ split_multi_section_blocks() [1624]
   â”‚  â”œâ”€ extract_text_from_block() [518]
   â”‚  â”œâ”€ should_split_block() [1603]
   â”‚  â””â”€ create_split_blocks() [1481]
   â”‚
   â”œâ”€ process_blocks_parallel() [1297]
   â”‚  â””â”€ ThreadPoolExecutor
   â”‚     â””â”€ process_block() [1365]
   â”‚        â”œâ”€ extract_text_from_block() [518]
   â”‚        â”‚  â”œâ”€ optimize_image_for_ocr() [389]
   â”‚        â”‚  â””â”€ pytesseract.image_to_string()
   â”‚        â”œâ”€ detect_block_type() [1302]
   â”‚        â”œâ”€ clean_text() [326]
   â”‚        â””â”€ translate_text() [86]
   â”‚           â””â”€ DeepL API call
   â”‚
   â”œâ”€ lp.draw_box() [Create visualization]
   â”‚
   â””â”€ create_translated_image() [827]
      â”œâ”€ calculate_optimal_font_size_for_filling() [851]
      â”œâ”€ get_original_style_info() [943]
      â”œâ”€ get_font_set() [754]
      â””â”€ PIL.ImageDraw operations
```

## ğŸ¨ **Visual Function Blocks**

### **ğŸ”§ Setup & Configuration Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 1-85: SETUP & CONFIGURATION      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ cache_result() [59-85]                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ @functools.wraps(func)              â”‚ â”‚
â”‚ â”‚ def wrapper(*args, **kwargs):       â”‚ â”‚
â”‚ â”‚   â€¢ Create cache key from args      â”‚ â”‚
â”‚ â”‚   â€¢ Try to load from .cache/        â”‚ â”‚
â”‚ â”‚   â€¢ Execute function if not cached  â”‚ â”‚
â”‚ â”‚   â€¢ Save result to cache            â”‚ â”‚
â”‚ â”‚   â€¢ Return result                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ğŸŒ Translation Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 86-138: TRANSLATION               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ @cache_result                           â”‚
â”‚ translate_text(text, target_lang="EN")  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Clean & normalize text            â”‚ â”‚
â”‚ â”‚ â€¢ Split into 4000-char chunks       â”‚ â”‚
â”‚ â”‚ â€¢ For each chunk:                   â”‚ â”‚
â”‚ â”‚   â”œâ”€ POST to DeepL API              â”‚ â”‚
â”‚ â”‚   â”œâ”€ Handle errors gracefully       â”‚ â”‚
â”‚ â”‚   â””â”€ Collect translated chunks      â”‚ â”‚
â”‚ â”‚ â€¢ Combine & restore formatting      â”‚ â”‚
â”‚ â”‚ â€¢ Return result                   â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ğŸ“„ PDF Processing Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 139-433: PDF PROCESSING           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ convert_pdf_to_image() [139-144]        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ pdf2image.convert_from_path()       â”‚ â”‚
â”‚ â”‚ return np.array(first_page)         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ get_text_style() [145-222]              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Open PDF with PyMuPDF             â”‚ â”‚
â”‚ â”‚ â€¢ Extract font info per block       â”‚ â”‚
â”‚ â”‚ â€¢ Detect text alignment             â”‚ â”‚
â”‚ â”‚ â€¢ Analyze paragraph structure       â”‚ â”‚
â”‚ â”‚ â€¢ Return style dictionary           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ optimize_image_for_ocr() [389-433]      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Convert to grayscale              â”‚ â”‚
â”‚ â”‚ â€¢ Apply CLAHE contrast enhancement  â”‚ â”‚
â”‚ â”‚ â€¢ Denoise with fastNlMeansDenoising â”‚ â”‚
â”‚ â”‚ â€¢ Adaptive thresholding             â”‚ â”‚
â”‚ â”‚ â€¢ Deskew if needed                  â”‚ â”‚
â”‚ â”‚ â€¢ Morphological noise removal       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ğŸ¤– AI Layout Detection Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 434-517: LAYOUT DETECTION         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ process_pdf_pages() [434-517]           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ For each page:                      â”‚ â”‚
â”‚ â”‚ â”œâ”€ Convert PDF page to image        â”‚ â”‚
â”‚ â”‚ â”œâ”€ Extract text styles              â”‚ â”‚
â”‚ â”‚ â”œâ”€ model.detect(image) [AI model]   â”‚ â”‚
â”‚ â”‚ â”œâ”€ Scale coordinates to image size  â”‚ â”‚
â”‚ â”‚ â”œâ”€ Merge overlapping blocks         â”‚ â”‚
â”‚ â”‚ â”œâ”€ Split multi-section blocks       â”‚ â”‚
â”‚ â”‚ â”œâ”€ Process blocks in parallel       â”‚ â”‚
â”‚ â”‚ â”œâ”€ Create visualization             â”‚ â”‚
â”‚ â”‚ â””â”€ Create translated image          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ğŸ‘ï¸ OCR Text Extraction Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 518-656: OCR TEXT EXTRACTION      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ extract_text_from_block() [518-656]     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Crop image to block coordinates   â”‚ â”‚
â”‚ â”‚ â€¢ Apply 4 preprocessing methods:    â”‚ â”‚
â”‚ â”‚   â”œâ”€ CLAHE + OTSU threshold         â”‚ â”‚
â”‚ â”‚   â”œâ”€ Adaptive threshold             â”‚ â”‚
â”‚ â”‚   â”œâ”€ Morphological operations       â”‚ â”‚
â”‚ â”‚   â””â”€ Denoise + OTSU threshold       â”‚ â”‚
â”‚ â”‚ â€¢ Try 5 PSM modes per method        â”‚ â”‚
â”‚ â”‚ â€¢ Score results by:                 â”‚ â”‚
â”‚ â”‚   â”œâ”€ Text length                    â”‚ â”‚
â”‚ â”‚   â”œâ”€ Recognizable patterns          â”‚ â”‚
â”‚ â”‚   â””â”€ Special character penalty      â”‚ â”‚
â”‚ â”‚ â€¢ Select best result               â”‚ â”‚
â”‚ â”‚ â€¢ Apply OCR error corrections       â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ğŸ”— Block Processing Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 657-1645: BLOCK PROCESSING        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ merge_overlapping_blocks() [657-753]    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Sort blocks by position           â”‚ â”‚
â”‚ â”‚ â€¢ Check overlap conditions:         â”‚ â”‚
â”‚ â”‚   â”œâ”€ Direct coordinate overlap      â”‚ â”‚
â”‚ â”‚   â”œâ”€ Vertical proximity             â”‚ â”‚
â”‚ â”‚   â”œâ”€ Horizontal alignment           â”‚ â”‚
â”‚ â”‚   â””â”€ Similar heights                â”‚ â”‚
â”‚ â”‚ â€¢ Merge qualifying blocks           â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ split_multi_section_blocks() [1624]     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ For each block:                     â”‚ â”‚
â”‚ â”‚ â”œâ”€ Extract text                     â”‚ â”‚
â”‚ â”‚ â”œâ”€ should_split_block()             â”‚ â”‚
â”‚ â”‚ â””â”€ create_split_blocks() if needed  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ create_split_blocks() [1481-1602]       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Find section markers:             â”‚ â”‚
â”‚ â”‚   â”œâ”€ INLOGGEGEVENS                  â”‚ â”‚
â”‚ â”‚   â”œâ”€ SEPA MACHTIGING                â”‚ â”‚
â”‚ â”‚   â”œâ”€ IBAN: / NL83                   â”‚ â”‚
â”‚ â”‚   â””â”€ BEVESTIGING                    â”‚ â”‚
â”‚ â”‚ â€¢ Calculate text positions          â”‚ â”‚
â”‚ â”‚ â€¢ Split block coordinates           â”‚ â”‚
â”‚ â”‚ â€¢ Assign block types                â”‚ â”‚
â”‚ â”‚ â€¢ Store pre-extracted text          â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ğŸ¨ Font & Image Generation Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 754-1264: FONT & IMAGE GENERATION â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ calculate_optimal_font_size() [851-942] â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ For each block:                     â”‚ â”‚
â”‚ â”‚ â”œâ”€ Test font sizes 14-46            â”‚ â”‚
â”‚ â”‚ â”œâ”€ Simulate text wrapping           â”‚ â”‚
â”‚ â”‚ â”œâ”€ Check 95% height constraint      â”‚ â”‚
â”‚ â”‚ â””â”€ Record max working size          â”‚ â”‚
â”‚ â”‚ Take minimum across all blocks      â”‚ â”‚
â”‚ â”‚ Ensure size in range 16-40          â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ create_translated_image() [827-1264]    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Create white background           â”‚ â”‚
â”‚ â”‚ â€¢ For each block:                   â”‚ â”‚
â”‚ â”‚   â”œâ”€ Draw colored background        â”‚ â”‚
â”‚ â”‚   â”œâ”€ Calculate optimal font size    â”‚ â”‚
â”‚ â”‚   â”œâ”€ Load appropriate font style    â”‚ â”‚
â”‚ â”‚   â”œâ”€ Wrap text to fit width         â”‚ â”‚
â”‚ â”‚   â”œâ”€ Position text with alignment   â”‚ â”‚
â”‚ â”‚   â”œâ”€ Draw text with proper color    â”‚ â”‚
â”‚ â”‚   â””â”€ Add block type label           â”‚ â”‚
â”‚ â”‚ â€¢ Return final PIL Image            â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **âš¡ Parallel Processing Block**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lines 1297-1480: PARALLEL PROCESSING    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ process_blocks_parallel() [1297-1480]   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Sort blocks by position           â”‚ â”‚
â”‚ â”‚ â€¢ Group into rows                   â”‚ â”‚
â”‚ â”‚ â€¢ ThreadPoolExecutor:               â”‚ â”‚
â”‚ â”‚   â””â”€ process_block() for each       â”‚ â”‚
â”‚ â”‚      â”œâ”€ Extract/use pre-text        â”‚ â”‚
â”‚ â”‚      â”œâ”€ Detect block type           â”‚ â”‚
â”‚ â”‚      â”œâ”€ Clean text                  â”‚ â”‚
â”‚ â”‚      â””â”€ Translate text              â”‚ â”‚
â”‚ â”‚ â€¢ Collect results                   â”‚ â”‚
â”‚ â”‚ â€¢ Sort by reading order             â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ **Data Transformation Flow**

```
INPUT                    TRANSFORMATIONS                     OUTPUT
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PDF     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ pdf2image       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ numpy   â”‚
â”‚ File    â”‚             â”‚ convert_from_   â”‚                â”‚ array   â”‚
â”‚         â”‚             â”‚ path()          â”‚                â”‚ (image) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Image   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Detectron2      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Layout  â”‚
â”‚ Array   â”‚             â”‚ model.detect()  â”‚                â”‚ Blocks  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layout  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ extract_text_   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Raw     â”‚
â”‚ Blocks  â”‚             â”‚ from_block()    â”‚                â”‚ Text    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Raw     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ translate_text()â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Trans-  â”‚
â”‚ Text    â”‚             â”‚ (DeepL API)     â”‚                â”‚ lated   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Trans-  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ create_         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Final   â”‚
â”‚ lated   â”‚             â”‚ translated_     â”‚                â”‚ PNG     â”‚
â”‚ Text    â”‚             â”‚ image()         â”‚                â”‚ Image   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

This comprehensive diagram shows exactly how the 1845-line script is organized, with specific line numbers, function relationships, and data flow. Each block has a clear responsibility and they work together to transform a PDF into a beautifully formatted, translated layout. 